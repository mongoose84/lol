# .github/workflows/deploy-api.yml
name: API - ASP .NET API CI & Deploy

# -------------------------------------------------
# When to run
# -------------------------------------------------
on:
  push:
    branches: [main]
    paths:
      - 'LolApi/**'          # only trigger when API code changes
  workflow_dispatch:         # manual trigger from the UI

# -------------------------------------------------
# Job definition
# -------------------------------------------------
jobs:
  build-and-deploy:
    runs-on: windows-latest               # needed for win‑x86 runtime
    env:
      # Folder where `dotnet publish` will drop the files
      PUBLISH_DIR: publish-output

    defaults:
      # Every `run:` step will start in the project folder
      run:
        working-directory: LolApi/lol-api

    steps:
      # -------------------------------------------------
      # Checkout the repo
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for versioning tools


       # --------------------------------------------------------------
      #  Upload the app_offline.htm marker (puts the site in “offline” mode)
      # --------------------------------------------------------------
      - name: Put site offline (app_offline.htm)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_URL }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}

          # Only upload the marker file – we keep everything else untouched
          local-dir: ./LolApi/ci-support                     # a folder that only contains app_offline.htm
          server-dir: ${{ secrets.FTP_SERVER_PATH }}  # root of the web‑site 

          # Force upload even if the file already exists
          dry-run: false

      # -------------------------------------------------
      # Set up .NET SDK
      # -------------------------------------------------
      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'          # adjust if you target another version

      # -------------------------------------------------
      # Restore NuGet packages (optional but clearer logs)
      # -------------------------------------------------
      - name: Restore dependencies
        run: dotnet restore

      # -------------------------------------------------
      # Publish a **self‑contained** Windows‑x86 binary
      # -------------------------------------------------
      - name: Publish (self-contained)
        run: |
          dotnet publish -c Release -r win-x86 --self-contained=true  -o./${{ env.PUBLISH_DIR }}

      # -------------------------------------------------
      # ***Write to the secrets file ***
      # -------------------------------------------------
      - name: Create secret   # runs on the default PowerShell shell
        env:
          RIOT_KEY: ${{ secrets.RIOT_API_KEY }}
          PUBLISH_DIR: ${{ env.PUBLISH_DIR }}   # "publish-output"
        run: |
          Write-Host "::add-mask::$env:RIOT_KEY"

          $targetPath = Join-Path -Path $env:PUBLISH_DIR -ChildPath "RiotSecret.txt"
          Set-Content -Path $targetPath -Value $env:RIOT_KEY -Encoding UTF8

          if (Test-Path -Path $targetPath) {
              Write-Host "✅ File created"
          } else {
              Write-Error "❌ Failed to create file"
              exit 1
          }

      # -------------------------------------------------
      # Verify the publish folder (helps debugging)
      # -------------------------------------------------
      - name: List publish output
        run: |
          echo "=== Files that will be uploaded ==="
          ls -R ./${{ env.PUBLISH_DIR }}

      # -------------------------------------------------
      # Deploy new files via FTPS
      # -------------------------------------------------
      - name: Deploy new files to FTP server
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_URL }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps
          port: 21
          # Point to the SAME folder we just verified
          local-dir: ./LolApi/lol-api/${{ env.PUBLISH_DIR }}/
          server-dir: ${{ secrets.FTP_SERVER_PATH }}
          # optional safety flags
          # dry-run: false
          # timeout: 30

      # --------------------------------------------------------------
      # emove the app_offline.htm marker (brings the site back online)
      # --------------------------------------------------------------
      - name: Bring site back online (delete app_offline.htm)
        uses: garygrossgarten/github-action-ftp-delete@v2
        with:
          host: ${{ secrets.FTP_URL }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          remoteFiles: ${{ secrets.FTP_SERVER_PATH }}/app_offline.htm
